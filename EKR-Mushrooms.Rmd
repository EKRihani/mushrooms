---
title: "Mushrooms Dataset Analysis"
author: "E.K. RIHANI"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
    number_sections: true   # Add section numbering
    toc: true
    toc_depth: 3

header-includes:
indent: true   # Indent paragraphs
bibliography: packages.bib #, references.bib
references:
  - id: mushroom2
    title: "Mushroom data creation, curation, and simulation to support classification tasks"
    author: D.Wagner, D.Heider, G.Hattab
    url: https://doi.org/10.1038/s41598-021-87602-3
    DOI: 10.1038/s41598-021-87602-3
    publisher: Scientific Reports
    type: article-journal
    issued:
      year: 2021
  - id: mushroom2b
    title: "Mushrooms & Toadstools"
    author: P.Hardin
    url: https://doi.org/10.1038/s41598-021-87602-3
    DOI: 10.1038/s41598-021-87602-3
    publisher: Collins
    type: book
    issued:
      year: 2012
  - id: mushroom1
    title: "Mushroom Data Set"
    author: J.Schlimmer
    url: https://archive.ics.uci.edu/ml/datasets/Mushroom
    DOI: 
    publisher: University of California
    type: article-journal
    issued:
      year: 1987
  - id: mushroom1b
    title: "The Audubon Society Field Guide to North American Mushrooms"
    author: G. H. Lincoff
    url: 
    DOI: 
    publisher: Alfred A. Knopf
    type: book
    issued:
      year: 1987
  - id: courtecuisse
    title: "Mushrooms and Toadstools"
    author: R.Courtecuisse, B. Duhem
    url: 
    DOI: 
    publisher: Collins
    type: book
    issued:
      year: 1995

csl: https://www.zotero.org/styles/vancouver-superscript
#- \usepackage{indentfirst} # Indent first line of each paragraph
---

```{r setup, include = FALSE}
load("EKR-mushrooms.RData")
if(!require(ggpubr)) install.packages("ggpubr", repos = "http://cran.us.r-project.org")
if(!require(rmarkdown)) install.packages("rmarkdown", repos = "http://cran.us.r-project.org")
if(!require(knitr)) install.packages("knitr", repos = "http://cran.us.r-project.org")
if(!require(tidyverse)) install.packages("tidyverse", repos = "http://cran.us.r-project.org")
#library(ggplot2)
library(ggpubr)   # Combine plots (ggarrange)
library(rmarkdown)
library(knitr)
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::write_bib(c("tidyverse", "rmarkdown", "knitr", "ggpubr"), "packages.bib")
#knitr::write_bib(c("tidyverse", "caret", "data.table", "reshape2", "ggplot2", "ggrepel", "recommenderlab", "stringr", "ggpubr", "rmarkdown", "knitr"), "packages.bib")
```
\newpage
\section{Overview}
\subsection{A word of caution}
\paragraph*{}
Mushroom identification is a difficult subject, that must **not** be taken lightly. The species of mushrooms one may encounter vary considerably from one ecosystem to another, from one continent to another, and no mushroom dataset or book can cover all the diversity of the fungal world.
\paragraph*{}
The dataset presented in this study, while being one of the most comprehensive mushrooms datasets in the data science area is by no means comprehensive. 
\paragraph*{}
Several genera are not present in this dataset, the most famous one probably being the *psylocybe* genre, known for its psychedelic properties. Several species are only mentioned by their common names, such as *destroying angel*, which may be used for several different species : *Amanita virosa*, *Amanita verna*, *Amanita bisporigera*, *Amanita ocreata*... Several famous species are missing, some of them toxic (*Rubroboletus satanas* or Satan's bolete), some of them delicious (*Amanita caesaria* or Caesar's mushroom) and easily confused with toxic ones (*Amanita muscaria* or fly agaric, which may lose its white spots, especially after strong rains), or the other way around (the entire *gyromitra* genre is missing, and can be confused with morels). 
\paragraph*{}
Some criteria may also vary wildly accordingly to the mushroom stage of maturity : while the green hats of mature *Amanita phalloides* (death caps) are easily recognizable, young specimens are white and can easily be confused with edible ones (such as specimens of the *Agaricus* genre).
\paragraph*{}
Some of these mushrooms are **deadly**, even when eaten in very small amounts. Mushroom poisoning diagnosis can be quite difficult, and often made to late to really act accordingly. Toxic compounds such as amanitins cannot be altered or destroyed by cooking or freezing, and will be absorbed by the intestine, pass into the bloodstream to then filtered by the liver, destroying the liver cells, and then being excreted in the intestines, to be reabsorded, filtered again... each pass destroying the remaining liver cells, in a cycle known as hepato-enteric reabsorption.
\paragraph*{}
Do not, **under any circumstances**, use this kind of dataset to determine if a mushroom is edible or not.

\subsection{Goal of the study}
\paragraph*{}
Mushroom and plants identification is a classic classification problem, which is usually performed manually, using identification tables. Most of these identification tables are actually based on a tree-based process, which seems pretty logical, given the tree-based logic of evolutionary processes. However, this logic has several limits.
\paragraph*{}
The first limit is the number of missing links. Some species have obviously become extinct, which means some of the branches and nodes of the phylogenetic tree are missing, which can complicate the analysis when two related species have a lot of missing common branches and nodes. Some similarities between species can also be missed.
\paragraph*{}
The second, and deeper limit is the inherent logic of the evolutionary process. Two antagonist phenomenons are at stake : evolutionary divergence and convergence. Both phenomenons are lined to the necessary adaptation of species to their environment. The evolutionary divergence explains the diversity of mammals : bats, whales and horses look very different because they have adapted to very different environments. The evolutionary convergence explains the similarity between the wing of a bat and the wing of the bee. However, despite their apparent dissimilarity, the wing of the bat is closer to the human hand than it is from the wing of the bee. The most reliable way to assess the evolutionary process and accurately find links between species is to analyze their genomes : visible characteristics can sometimes be very misleading. However, these characteristics often are the only ones available.
\paragraph*{}
The third problem is the primary endpoint of the classification. This endpoint may or may not be linked to the evolutionary process or the visible criteria, especially if this endpoint is vague. Our "not edible" endpoint lies in this category, for several reasons : it is mostly centered on human-only toxicity, many very different toxicity mechanisms can exist and the toxicity or non-toxicity of a fungic or vegetal metabolite can be linked to very tenuous modifications from one specie to another.
\paragraph*{}
For these reasons among others, the tree-based logic, while commonly used in mushrooms and plants identification, and allegedly justified by the tree-based evolutionary process, may not necessarily be the most optimal approach to species classification based on visual criteria. The aim of this study is to perform this classification task based on limited visual cues, and to assess the performance of several classification strategies.
\subsection{The dataset}
\paragraph*{}
The Secondary Mushroom Identification Dataset was submitted by Dennis Wagner in 2021[@mushroom2][@mushroom2b], and is inspired by the Mushroom Dataset created by Jeff Schlimmer in 1987[@mushroom1][@mushroom1b]. Both datasets aim to create a fictional collection of mushrooms, built by gathering characteristics about a selected number of mushroom species, then randomizing each individual mushroom quantitative variables along the species typical characteristics (i.e. cap diameter, stem  height, stem width).  
\paragraph*{}
This dataset contains the data from n = `r summary_number` mushrooms (rows). Each mushroom has `r nrow(structure_dataset)` attributes (columns) :
\paragraph*{}
* *Class* : edible (e) or poisonous (p)
* *Cap diameter* : in centimeters
* *Cap shape* : bell (b), conical (c), convex (x), flat (f), sunken (s), spherical (p) or other (o)
* *Cap surface* : fibrous (i), grooves (g), scaly (y), smooth (s), shiny (h), leathery (l), silky (k), sticky (t), wrinkled (w), downy (d) or fleshy (e)
* *Cap color* : brown (n), buff (b), gray (g), green (r), pink (p), purple (u), red (e), white (w), yellow (y), blue (l), orange (o) or black (k)
* *Does bruise or bleed* : true (t) or false (f)
* *Gill attachment* : adnate (a), adnexed (x), decurrent (d), free (e), sinuate (s), pores (p), none (f), unknown (?)
* *Gill spacing* : close (c), distant (d), none (f)
* *Gill color* : brown (n), buff (b), gray (g), green (r), pink (p), purple (u), red (e), white (w), yellow (y), blue (l), orange (o), black (k) or none (f)
* *Stem height* : in centimeters
* *Stem width* : in millimeters
* *Stem root* : bulbous (b), swollen (s), club (c), cup (u), equal (e), rhizomorphs (z), rooted (r) or none (f)
* *Stem surface* : fibrous (i), grooves (g), scaly (y), smooth (s), shiny (h), leathery (l), silky (k), sticky (t), wrinkled (w), fleshy (e) or none (f)
* *Stem color* : brown (n), buff (b), gray (g), green (r), pink (p), purple (u), red (e), white (w), yellow (y), blue (l), orange (o), black (k) or none (f)
* *Veil type* : partial (p) or universal (u)
* *Veil color* : brown (n), buff (b), gray (g), green (r), pink (p), purple (u), red (e), white (w), yellow (y), blue (l), orange (o), black (k) or none (f)
* *Has ring* : true (t) or false (f)
* *Ring type* : cobwebby (c), evanescent (e), flaring (r), grooved (g), large (l), pendant (p), sheathing (s), zone (z), scaly (y), movable (m), none (f) or unknown (?)
* *Spore print color* : brown (n), buff (b), gray (g), green (r), pink (p), purple (u), red (e), white (w), yellow (y), blue (l), orange (o), black (k) or none (f)
* *Habitat* : grasses (g), leaves"(l), meadows (m), paths (p), heaths (h), urban (u), waste (w) or woods (d)
* *Season* : spring (s), summer (u), autumn (a) or winter (w)

\newpage
\section{Methods and Analysis}
\subsection{Computer and R configuration}
\paragraph*{}
The code, benchmarks and report were run on the following computer configuration :

* CPU : AMD Ryzen 5 5600G
* RAM : 2x16 GB DDR4-3200
* SSD : Crucial P5 M2 NVMe
* OS : Xubuntu Linux
* R : version 3.6.3
* Packages : tidyverse[@R-tidyverse] (v1.3.1), ggrepel[@R-ggrepel] (v0.9.1), ggpubr[@R-ggpubr] (v0.4.0), rmarkdown[@R-rmarkdown] (v2.11), knitr[@R-knitr] (v1.34).

\paragraph*{}
The code was also tested on a Windows 7 x64 SP1 computer with 16 GB RAM, and R 4.1.0. It was not tested on any Mac OS system.
\subsection{Data preparation and cleaning}
\paragraph*{}
The dataset is directly downloaded from the UCI database in zip format and unzipped. The archive contains four files :

* *primary_data.csv* : the csv file with all data used for creating the base. One line for each of the 173 species.
* *primary_data_meta.txt* : metadata for the primary dataset.
* *secondary_data.csv* : the final dataset, made of all  `r summary_number` specimen.
* *secondary_data_meta.txt* : metadata for the secondary dataset.

\paragraph*{}
The file of interest (*secondary_data.csv*) is extracted using the *read.csv* function.
\paragraph*{}
The initial and final structures of the dataset are as following :
```{r out.width = "90%", echo = FALSE}
kable(structure_dataset, caption = "Dataset structure")
```
The import automatically converted all character variables to factors. The only structural modification was to modify some of the 2-level factors into logical variables.
\paragraph*{}
The primary and secondary *data_meta* files include all information to translate the one-letter variable codes into comprehensible words. However, two variable codes are missing.
\paragraph*{}
Firstly, the *stem.root = f* value isn't explained. Since most *f* values for the other categorical stem variables (*stem.surface*, *stem.color*) mean the mushroom has no stem and given the fact that all stem.root = f values are always associated with *stem.surface = f*, *stem.color = f*, *stem.height = 0* and *stem.width = 0*, one can safely assume that *stem.root = f* simply means there is no stem.
```{r out.width = "90%", echo = FALSE}

kable(uniques_missing_f, caption = "Unique values for stem.root = 'f'")
```
\paragraph*{}
Secondly, the *cap.surface = d* value isn't explain either. There was no workaround to lift this uncertainty except from performing some searches : digging into the primary dataset, finding all the mushrooms that may have the value *cap.surface = d*, translating the common english name into the scientific (latin) ones and finding the relevant descriptions in mycology books.[@courtecuisse]
\paragraph*{}
This research showed all these mushrooms to have a velvety, or downy surface. A value d = downy was thus assumed.
\paragraph*{}
These issues underline why it is important to provide extensive documentation, well-defined variables and values in every datasets and to follow international standards (such as latin names). Fortunately, the author provides the primary dataset with the characteristics of all species; without that file, it would have been impossible to find what characteristic lied under the *cap.surface = d* value.
\paragraph*{}
After this data cleaning and editing steps, we can get basic information about our mushroom population, such as dimensional distributions.  
```{r, echo = FALSE, fig.cap = "Mushroom cap diameter, stem height and stem width distribution"}
plot(ggarrange(
   ncol = 3,
   study_distrib_cap.diameter + ggtitle("") + ylab("") + scale_y_continuous(labels = NULL),
   study_distrib_stem.height + ggtitle("") + ylab("") + scale_y_continuous(labels = NULL),
   study_distrib_stem.width + ggtitle("") + ylab("") + scale_y_continuous(labels = NULL)
   )
)
```  
\paragraph*{}
All dimensional distributions seem to roughly follow a bell curbe, with a long tail towards the higher values.
\paragraph*{}
A logarithmic transformation can help us see the shape of this tail.  
```{r, echo = FALSE, fig.cap = "Mushroom cap diameter, stem height and stem width distribution"}
plot(ggarrange(
   ncol = 3,
   study_distrib_cap.diameter + ggtitle("") + ylab("") + scale_y_log10(labels = NULL),
   study_distrib_stem.height + ggtitle("") + ylab("") + scale_y_log10(labels = NULL),
   study_distrib_stem.width + ggtitle("") + ylab("") + scale_y_log10(labels = NULL)
   )
)
```  
\paragraph*{}
The cap diameter distribution looks like a bell curve with a long right tail but actually is bimodal, with a main mode toward 5 cm, and a much smaller secondary mode toward 50 cm. This size can look quite surprising, but some species such as *Polyporus squamosus* (dryad's saddle) can be very large with some specimens that can weight up to 5 kg.
\paragraph*{}
The stem height distribution also looks like a bell curve with a long right tail, a main mode around 5 cm, and a secondary mode at 0 cm. Again, this can look surprising, but some mushrooms have no stem, which could explain this height value.
\paragraph*{}
The stem width distribution looks like a bell curve with a long right tail, and a peak around 12 mm. In all three distributions, the right tail can probably be explained by the impossibility to have negative dimensional values.

\subsection{Training, validation and evaluation sets}
\paragraph*{}


\subsection{Training set analysis}
\paragraph*{}
Once the original dataset is split in training, validation and evaluation sets, one can have a look at the characteristics of the edible and toxic populations and draw conclusions without any risk of overfitting.
```{r, echo = FALSE, fig.cap = "Mushroom characteristic on the training set"}
plot(ggarrange(
   ncol = 3,
   train_distrib_cap.diameter + ggtitle("Cap Diameter"),
   train_distrib_stem.height + ggtitle("Stem Height"),
   train_distrib_stem.width + ggtitle("Stem Width")#,
#   train_distrib_habitat + ggtitle("Habitat"),
#   train_distrib_stem.color + ggtitle("Stem Color"),
#   train_distrib_veil.color + ggtitle("Veil Color")
   )
)
```  

\newpage
\section{Results}

*Section that presents the modeling results and discusses the model performance.*

\newpage
\section{Conclusion}

*Section that gives a brief summary of the report, its limitations and future work*

\newpage
\section{References}
